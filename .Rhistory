all_dat <- asl_chum %>%
filter(stock_group == region) %>%
mutate(mean = scale(mean))  %>%
spread(Salt.Water.Age, mean) %>%
slice(which(`5` ==is.na(`5`)))
View(all_dat)
View(all_dat_mat)
all_dat <-   na.omit(all_dat)
##  0s are replaced with NA's and the data z-scored
all_dat <- asl_chum %>%
filter(stock_group == region) %>%
mutate(mean = scale(mean))  %>%
spread(Salt.Water.Age, mean) %>%
ungroup() %>%
arrange(sampleYear) %>%
dplyr::select(-sampleYear, -stock_group)
all_dat <-   na.omit(all_dat)
View(all_dat)
##  0s are replaced with NA's and the data z-scored
all_dat <- asl_chum %>%
filter(stock_group == region) %>%
mutate(mean = scale(mean))  %>%
spread(Salt.Water.Age, mean) %>%
ungroup() %>%
arrange(sampleYear) %>%
dplyr::select(-sampleYear, -stock_group)
all_dat <-   na.omit(all_dat)
all_dat_mat <- t(all_dat)
# fit models with a RW 1 trend process
dfa_rw <- fit_dfa(y = all_dat_mat, iter = mcmc_iter, thin = mcmc_thin, scale="zscore", chains = mcmc_chains, num_trends = 1,par_list="all")
loos_rw = loo::loo(dfa_rw$model,moment_match=TRUE)$estimates[3,]
# fit models with varying numbers of knots in a b-spline
dfa_bs<- fit_dfa(y = all_dat_mat, iter = mcmc_iter, thin = mcmc_thin,scale="zscore",
chains = mcmc_chains, num_trends = 1, trend_model = "bs",
n_knots = 16,par_list="all")
loos_bs = loo::loo(dfa_bs$model,moment_match=TRUE)$estimates[3,]
# fit models with a Gaussian process
dfa_gp<- fit_dfa(y = all_dat_mat, iter = mcmc_iter, thin = mcmc_thin,scale="zscore",
chains = mcmc_chains, num_trends = 1, trend_model = "gp",
n_knots = 16,par_list="all")
loos_gp = loo::loo(dfa_gp$model,moment_match=TRUE)$estimates[3,]
loo_size_age_output[[i]] = data.frame(model = c("dfa_rw", "dfa_bs", "dfa_gp"),
LOOIC = c(loos_rw[1],loos_bs[1],  loos_gp[1]),
SE = c(loos_rw[2],loos_bs[2],  loos_gp[2]))
dfa_size_age_output[[i]] <- list(dfa_rw,dfa_bs,dfa_gp)
View(dfa_size_age_output)
# names <-c("dfa_rw", "dfa_bs", "dfa_gp")
# names(dfa_size_age_output) <- names
#
#name the DFA List
names(dfa_size_age_output) <- region_list
View(dfa_size_age_output)
model_names = c("dfa_rw", "dfa_bs", "dfa_gp")
names(dfa_size_age_output[[i]]) <- model_names
View(dfa_size_age_output)
View(loo_size_age_output)
r <- rotate_trends(dfa_size_age_output$summer_chum_yukon$dfa_rw)
plot_trends(r) + theme_bw()
plot_fitted(dfa_size_age_output$Yukon[[1]]) + theme_bw()
plot_fitted(dfa_size_age_output$summer_chum_yukon$dfa_rw) + theme_bw()
plot_trends(r) + theme_bw()
k <- rotate_trends(dfa_size_age_output$summer_chum_yukon$dfa_bs)
plot_trends(k) + theme_bw()
plot_fitted(dfa_size_age_output$summer_chum_yukon$dfa_bs) + theme_bw()
k <- rotate_trends(dfa_size_age_output$summer_chum_yukon$dfa_gp)
plot_trends(k) + theme_bw()
plot_fitted(dfa_size_age_output$summer_chum_yukon$dfa_gp) + theme_bw()
i=1
region <- region_list[[i]]
##  0s are replaced with NA's and the data z-scored
all_dat <- asl_chum %>%
filter(stock_group == region) %>%
mutate(mean = scale(mean))  %>%
spread(Salt.Water.Age, mean) %>%
ungroup() %>%
arrange(sampleYear) %>%
dplyr::select(-sampleYear, -stock_group)
all_dat <-   na.omit(all_dat)
all_dat_mat <- t(all_dat)
# fit models with a RW 1 trend process
dfa_rw <- fit_dfa(y = all_dat_mat, iter = mcmc_iter, thin = mcmc_thin, scale="zscore", chains = mcmc_chains, num_trends = 1,par_list="all")
loos_rw = loo::loo(dfa_rw$model,moment_match=TRUE)$estimates[3,]
# fit models with varying numbers of knots in a b-spline
dfa_bs<- fit_dfa(y = all_dat_mat, iter = mcmc_iter, thin = mcmc_thin,scale="zscore",
chains = mcmc_chains, num_trends = 1, trend_model = "bs",
n_knots = 16,par_list="all")
loos_bs = loo::loo(dfa_bs$model,moment_match=TRUE)$estimates[3,]
# fit models with a Gaussian process
dfa_gp<- fit_dfa(y = all_dat_mat, iter = mcmc_iter, thin = mcmc_thin,scale="zscore",
chains = mcmc_chains, num_trends = 1, trend_model = "gp",
n_knots = 16,par_list="all")
loos_gp = loo::loo(dfa_gp$model,moment_match=TRUE)$estimates[3,]
loo_size_age_output[[i]] = data.frame(model = c("dfa_rw", "dfa_bs", "dfa_gp"),
LOOIC = c(loos_rw[1],loos_bs[1],  loos_gp[1]),
SE = c(loos_rw[2],loos_bs[2],  loos_gp[2]))
dfa_size_age_output[[i]] <- list(dfa_rw,dfa_bs,dfa_gp)
model_names = c("dfa_rw", "dfa_bs", "dfa_gp")
names(dfa_size_age_output[[i]]) <- model_names
#name the DFA List
names(dfa_size_age_output) <- region_list
r <- rotate_trends(dfa_size_age_output$summer_chum_yukon$dfa_rw)
plot_trends(r) + theme_bw()
k <- rotate_trends(dfa_size_age_output$summer_chum_yukon$dfa_bs)
plot_trends(k) + theme_bw()
k <- rotate_trends(dfa_size_age_output$summer_chum_yukon$dfa_gp)
plot_trends(k) + theme_bw()
View(loo_size_age_output)
i=2
region <- region_list[[i]]
##  0s are replaced with NA's and the data z-scored
all_dat <- asl_chum %>%
filter(stock_group == region) %>%
mutate(mean = scale(mean))  %>%
spread(Salt.Water.Age, mean) %>%
ungroup() %>%
arrange(sampleYear) %>%
dplyr::select(-sampleYear, -stock_group)
all_dat <-   na.omit(all_dat)
all_dat_mat <- t(all_dat)
# fit models with a RW 1 trend process
dfa_rw <- fit_dfa(y = all_dat_mat, iter = mcmc_iter, thin = mcmc_thin, scale="zscore", chains = mcmc_chains, num_trends = 1,par_list="all")
loos_rw = loo::loo(dfa_rw$model,moment_match=TRUE)$estimates[3,]
# fit models with varying numbers of knots in a b-spline
dfa_bs<- fit_dfa(y = all_dat_mat, iter = mcmc_iter, thin = mcmc_thin,scale="zscore",
chains = mcmc_chains, num_trends = 1, trend_model = "bs",
n_knots = 16,par_list="all")
loos_bs = loo::loo(dfa_bs$model,moment_match=TRUE)$estimates[3,]
# fit models with a Gaussian process
dfa_gp<- fit_dfa(y = all_dat_mat, iter = mcmc_iter, thin = mcmc_thin,scale="zscore",
chains = mcmc_chains, num_trends = 1, trend_model = "gp",
n_knots = 16,par_list="all")
loos_gp = loo::loo(dfa_gp$model,moment_match=TRUE)$estimates[3,]
loo_size_age_output[[i]] = data.frame(model = c("dfa_rw", "dfa_bs", "dfa_gp"),
LOOIC = c(loos_rw[1],loos_bs[1],  loos_gp[1]),
SE = c(loos_rw[2],loos_bs[2],  loos_gp[2]))
dfa_size_age_output[[i]] <- list(dfa_rw,dfa_bs,dfa_gp)
model_names = c("dfa_rw", "dfa_bs", "dfa_gp")
names(dfa_size_age_output[[i]]) <- model_names
# mod_select<- loo_compare %>%
#   mutate(flag = case_when(LOOIC == min(LOOIC) ~ 1,
#                           TRUE ~ 0)) %>%
#   filter(flag ==1) %>%
#   dplyr::select(model)
# best_mod<-
r <- rotate_trends(dfa_size_age_output$summer_chum_yukon$dfa_rw)
plot_trends(r) + theme_bw()
k <- rotate_trends(dfa_size_age_output$fall_chum_yukon$dfa_rw)
plot_trends(k) + theme_bw()
k <- rotate_trends(dfa_size_age_output$fall_chum_yukon$dfa_rw)
plot_trends(k) + theme_bw() + ggtitle("Fall Yukon Chum")
k <- rotate_trends(dfa_size_age_output$chum_kuskokwim$dfa_rw)
plot_trends(k) + theme_bw() + ggtitle("Kuskokwim Chum")
View(asl_dat)
##  0s are replaced with NA's and the data z-scored
all_dat <- asl_chum %>%
filter(stock_group == region,
ASLProjectType %in% c("commercial catch", "escapement")) %>%
dplyr::mutate(mean = scale(mean))  %>%
spread(Salt.Water.Age, mean) %>%
ungroup() %>%
arrange(sampleYear) %>%
dplyr::select(-sampleYear, -stock_group)
asl_chum <- asl_dat %>%
filter(Species == "chum",
!sampleYear < 1980,
ASLProjectType %in% c("commercial catch", "escapement"),
SASAP.Region %in% c("Yukon", "Kuskokwim"),
!Fresh.Water.Age == "NA") %>%
dplyr::mutate(stock_group = case_when(SASAP.Region == "Kuskokwim" ~ "chum_kuskokwim",
LocationID %in% upper ~ "fall_chum_yukon",
LocationID %in% middle ~ "fall_chum_yukon",
LocationID %in% lower ~ "summer_chum_yukon",
Lon > -141 ~ "fall_chum_yukon",
Lat <= 63 ~ "summer_chum_yukon",
Lat > 63 ~ "fall_chum_yukon",
TRUE ~ "NA")) %>%
filter(!stock_group == "NA") %>% # 5 NA's, one from Utquaivik the rest are from general yukon district, all from 2009...
group_by(stock_group, Salt.Water.Age,sampleYear) %>%
dplyr::summarise(mean = mean(mean)) %>%
filter(Salt.Water.Age %in% c(2,3,4,5,6,7))
asl_chum <- asl_dat %>%
filter(Species == "chum",
!sampleYear < 1980,
# ASLProjectType %in% c("commercial catch", "escapement"),
SASAP.Region %in% c("Yukon", "Kuskokwim"),
!Fresh.Water.Age == "NA") %>%
dplyr::mutate(stock_group = case_when(SASAP.Region == "Kuskokwim" ~ "chum_kuskokwim",
LocationID %in% upper ~ "fall_chum_yukon",
LocationID %in% middle ~ "fall_chum_yukon",
LocationID %in% lower ~ "summer_chum_yukon",
Lon > -141 ~ "fall_chum_yukon",
Lat <= 63 ~ "summer_chum_yukon",
Lat > 63 ~ "fall_chum_yukon",
TRUE ~ "NA")) %>%
filter(!stock_group == "NA") %>% # 5 NA's, one from Utquaivik the rest are from general yukon district, all from 2009...
group_by(stock_group, Salt.Water.Age,sampleYear) %>%
dplyr::summarise(mean = mean(mean)) %>%
filter(Salt.Water.Age %in% c(2,3,4,5,6,7))
AL_chum <- asl_chum %>%
group_by(stock_group, sampleYear) %>%
dplyr::summarise(mean_age = mean(Salt.Water.Age))
View(AL_chum)
View(asl_chum)
chum _tidy <- asl_dat %>%
filter(Species == "chum",
!sampleYear < 1980,
ASLProjectType %in% c("commercial catch", "escapement"),
SASAP.Region %in% c("Yukon", "Kuskokwim"),
!Fresh.Water.Age == "NA") %>%
dplyr::mutate(stock_group = case_when(SASAP.Region == "Kuskokwim" ~ "chum_kuskokwim",
LocationID %in% upper ~ "fall_chum_yukon",
LocationID %in% middle ~ "fall_chum_yukon",
LocationID %in% lower ~ "summer_chum_yukon",
Lon > -141 ~ "fall_chum_yukon",
Lat <= 63 ~ "summer_chum_yukon",
Lat > 63 ~ "fall_chum_yukon",
TRUE ~ "NA")) %>%
filter(!stock_group == "NA") #%>% # 5 NA's, one from Utquaivik the rest are from general yukon district, all from 2009...
asl_dat <-read.csv("data/ASL_summary_byFWSWage.csv")
chum_tidy <- asl_dat %>%
filter(Species == "chum",
!sampleYear < 1980,
ASLProjectType %in% c("commercial catch", "escapement"),
SASAP.Region %in% c("Yukon", "Kuskokwim"),
!Fresh.Water.Age == "NA") %>%
dplyr::mutate(stock_group = case_when(SASAP.Region == "Kuskokwim" ~ "chum_kuskokwim",
LocationID %in% upper ~ "fall_chum_yukon",
LocationID %in% middle ~ "fall_chum_yukon",
LocationID %in% lower ~ "summer_chum_yukon",
Lon > -141 ~ "fall_chum_yukon",
Lat <= 63 ~ "summer_chum_yukon",
Lat > 63 ~ "fall_chum_yukon",
TRUE ~ "NA")) %>%
filter(!stock_group == "NA") #%>% # 5 NA's, one from Utquaivik the rest are from general yukon district, all from 2009...
asl_chum <- chum_tidy %>%
group_by(stock_group, Salt.Water.Age,sampleYear) %>%
dplyr::summarise(mean = mean(mean)) %>%
filter(Salt.Water.Age %in% c(2,3,4,5,6,7))
AL_chum <- chum_tidy %>%
group_by(stock_group, sampleYear) %>%
dplyr::summarise(mean_age = mean(Salt.Water.Age))
View(AL_chum)
AL_all_dat <- AL_chum %>%
dplyr::mutate(mean = scale(mean_age))  %>%
spread(stock_group, mean) %>%
ungroup() %>%
arrange(sampleYear)
View(AL_all_dat)
AL_all_dat <- AL_chum %>%
dplyr::mutate(mean_age = scale(mean_age))  %>%
spread(stock_group, mean_age)
##  0s are replaced with NA's and the data z-scored
AL_all_dat <- AL_chum %>%
dplyr::mutate(mean_age = scale(mean_age))  %>%
spread(stock_group, mean_age) %>%
ungroup() %>%
arrange(sampleYear) %>%
dplyr::select(-sampleYear, -stock_group)
##  0s are replaced with NA's and the data z-scored
AL_all_dat <- AL_chum %>%
dplyr::mutate(mean_age = scale(mean_age))  %>%
spread(stock_group, mean_age) %>%
ungroup() %>%
arrange(sampleYear)
##  0s are replaced with NA's and the data z-scored
AL_all_dat <- AL_chum %>%
dplyr::mutate(mean_age = scale(mean_age))  %>%
spread(stock_group, mean_age) %>%
ungroup() %>%
arrange(sampleYear) %>%
dplyr::select(-sampleYear)
all_dat <-   na.omit(all_dat)
all_dat_mat <- t(all_dat)
View(all_dat_mat)
# fit models with a RW 1 trend process
dfa_rw <- fit_dfa(y = all_dat_mat, iter = mcmc_iter, thin = mcmc_thin, scale="zscore", chains = mcmc_chains, num_trends = 1,par_list="all")
loos_rw = loo::loo(dfa_rw$model,moment_match=TRUE)$estimates[3,]
# fit models with varying numbers of knots in a b-spline
dfa_bs<- fit_dfa(y = all_dat_mat, iter = mcmc_iter, thin = mcmc_thin,scale="zscore",
chains = mcmc_chains, num_trends = 1, trend_model = "bs",
n_knots = 16,par_list="all")
loos_bs = loo::loo(dfa_bs$model,moment_match=TRUE)$estimates[3,]
# fit models with a Gaussian process
dfa_gp<- fit_dfa(y = all_dat_mat, iter = mcmc_iter, thin = mcmc_thin,scale="zscore",
chains = mcmc_chains, num_trends = 1, trend_model = "gp",
n_knots = 16,par_list="all")
loos_gp = loo::loo(dfa_gp$model,moment_match=TRUE)$estimates[3,]
AL_loo_size_age_output = data.frame(model = c("dfa_rw", "dfa_bs", "dfa_gp"),
LOOIC = c(loos_rw[1],loos_bs[1],  loos_gp[1]),
SE = c(loos_rw[2],loos_bs[2],  loos_gp[2]))
AL_dfa_size_age_output <- list(dfa_rw,dfa_bs,dfa_gp)
names(dfa_size_age_output) <- region_list
View(AL_loo_size_age_output)
r <- rotate_trends(AL_dfa_size_age_output$dfa_rw)
r <- rotate_trends(AL_dfa_size_age_output[[1]])
plot_trends(r) + theme_bw() ++ ggtitle("AL all")
plot_trends(r) + theme_bw() + ggtitle("AL all")
plot_fitted(AL_dfa_size_age_output[[1]]) + theme_bw()
View(AL_dfa_size_age_output)
AL_all_dat <-   na.omit(AL_all_dat)
all_dat_mat <- t(AL_all_dat)
# fit models with a RW 1 trend process
dfa_rw <- fit_dfa(y = all_dat_mat, iter = mcmc_iter, thin = mcmc_thin, scale="zscore", chains = mcmc_chains, num_trends = 1,par_list="all")
loos_rw = loo::loo(dfa_rw$model,moment_match=TRUE)$estimates[3,]
r <- rotate_trends(AL_dfa_size_age_output[[1]])
plot_trends(r) + theme_bw() + ggtitle("AL RW")
plot_fitted(AL_dfa_size_age_output[[1]]) + theme_bw()
View(all_dat)
View(all_dat_mat)
View(AL_dfa_size_age_output)
upper <- c("Dawson (Village/City)","Yukon Crossing, Y.T., Canada (Village/City)","Bearfeed Creek","Big Salmon River",
"Blind Creek" )
middle <-c( "Anvik Bluff", "Anvik River","Fairbanks (Village/City)","Galena (Village/City)",
"Manley (Village/City)", "Nenana (Village/City)","Nulato (Village/City)","Rampart (Village/City)",
"Rampart Rapids", "Ruby (Village/City)", "Stevens Village (Village/City)","Tanana (Village/City)",
"Y4 (Subdistrict 4)", "Y5 (Subdistrict 5)","Y6 (Subdistrict 6)","Beaver (Village/City)","Chatanika (Village/City)",
"Chena River","Chulitna River","Clear (Village/City)", "Gisasa River", "Goodpaster River", "Henshaw Creek","Kaltag (Village/City)"
)
lower <-c("Alakanuk (Village/City)", "Big Eddy", "Emmonak (Village/City)","Flat Island","Grayling (Village/City)",
"Halfway Island","Kotlik (Village/City)", "Marshall (Village/City)","Mountain Village (Village/City)",
"Ohogamiut (Village/City)","Pilot Station (Village/City)", "St Marys (Village/City)","Y1 (Subdistrict 1)",
"Y2 (Subdistrict 2)","Y3 (Subdistrict 3)","Andreafsky River", "Andreafsky River (East Fork)", "Ingersoll Islands"
)
knitr::opts_chunk$set(echo = TRUE)
library(here)
library(tidyverse)
library(MARSS)
library(bayesdfa)
#load explore and tidy ASL data to go into a DFA for alpha parameter
#ASL data is from open knowledge network, Oke et al 2020. Here: https://knb.ecoinformatics.org/view/doi:10.5063/F1707ZTM
asl_dat <-read.csv("data/ASL_summary_byFWSWage.csv")
# separate Chum into Fall and Summer based on upper and lower spawning locations.
# Fall = upper, summer = lower
fall_chum_yukon <- c( )
summer_chum_yukon <- c( )
chum_tidy <- asl_dat %>%
filter(Species == "chum",
!sampleYear < 1980,
ASLProjectType %in% c("commercial catch", "escapement"),
SASAP.Region %in% c("Yukon", "Kuskokwim"),
!Fresh.Water.Age == "NA") %>%
dplyr::mutate(stock_group = case_when(SASAP.Region == "Kuskokwim" ~ "chum_kuskokwim",
LocationID %in% upper ~ "fall_chum_yukon",
LocationID %in% middle ~ "fall_chum_yukon",
LocationID %in% lower ~ "summer_chum_yukon",
Lon > -141 ~ "fall_chum_yukon",
Lat <= 63 ~ "summer_chum_yukon",
Lat > 63 ~ "fall_chum_yukon",
TRUE ~ "NA")) %>%
filter(!stock_group == "NA") #%>% # 5 NA's, one from Utquaivik the rest are from general yukon district, all from 2009...
asl_chum <- chum_tidy %>%
group_by(stock_group, Salt.Water.Age,sampleYear) %>%
dplyr::summarise(mean = mean(mean)) %>%
filter(Salt.Water.Age %in% c(2,3,4,5,6,7))
ggplot(data = asl_chum) +
geom_point(aes(x=as.numeric(sampleYear), y = mean)) +
facet_grid(Salt.Water.Age~stock_group) +
theme_classic()
AL_chum <- chum_tidy %>%
group_by(stock_group, sampleYear) %>%
dplyr::summarise(mean_age = mean(Salt.Water.Age))
AL_chum <- chum_tidy %>%
filter(ASLProjectType == "escapement") %>%
group_by(stock_group, sampleYear) %>%
dplyr::summarise(mean_age = mean(Salt.Water.Age))
View(AL_chum)
AL_chum <- chum_tidy %>%
filter(ASLProjectType == "escapement") %>%
group_by(stock_group, sampleYear) %>%
dplyr::summarise(mean_age = mean(Salt.Water.Age))
mcmc_iter <- 4000
mcmc_chains <- 3
mcmc_thin <- 10
region_list <- unique(asl_chum$stock_group)
dfa_size_age_output <- list()
loo_size_age_output <- list()
##  0s are replaced with NA's and the data z-scored
AL_all_dat <- AL_chum %>%
dplyr::mutate(mean_age = scale(mean_age))  %>%
spread(stock_group, mean_age) %>%
ungroup() %>%
arrange(sampleYear) %>%
dplyr::select(-sampleYear)
View(AL_all_dat)
#should probably fill in blanks with mean data?? for now just omit.
AL_all_dat <-   na.omit(AL_all_dat)
all_dat_mat <- t(AL_all_dat)
View(all_dat_mat)
all_dat_mat[1,]
# fit models with a RW 1 trend process
dfa_rw <- fit_dfa(y = all_dat_mat[1,], iter = mcmc_iter, thin = mcmc_thin, scale="zscore", chains = mcmc_chains, num_trends = 1,par_list="all")
# fit models with a RW 1 trend process
dfa_rw <- fit_dfa(y = all_dat_mat, iter = mcmc_iter, thin = mcmc_thin, scale="zscore", chains = mcmc_chains, num_trends = 1,par_list="all")
r <- rotate_trends(dfa_rw)
plot_trends(r) + theme_bw() + ggtitle("AL RW")
plot_fitted(dfa_rw) + theme_bw()
r <- rotate_trends(dfa_bs)
# fit models with varying numbers of knots in a b-spline
dfa_bs<- fit_dfa(y = all_dat_mat, iter = mcmc_iter, thin = mcmc_thin,scale="zscore",
chains = mcmc_chains, num_trends = 1, trend_model = "bs",
n_knots = 16,par_list="all")
k <- rotate_trends(dfa_bs)
plot_trends(k) + theme_bw() + ggtitle("Fall Yukon Chum")
plot_fitted(dfa_bs) + theme_bw()
AL_chum <- chum_tidy %>%
#filter(ASLProjectType == "escapement") %>%
group_by(stock_group, sampleYear) %>%
count(Salt.Water.Age)
View(AL_chum)
ggplot(data = AL_chum) +
geom_point(aes(x=as.numeric(sampleYear), y = n)) +
facet_grid(Salt.Water.Age~stock_group) +
theme_classic()
ggplot(data = AL_chum) +
geom_point(aes(x=as.numeric(sampleYear), y = n)) +
facet_grid(Salt.Water.Age~stock_group, scales = "free_y") +
theme_classic()
AL_chum <- chum_tidy %>%
#filter(ASLProjectType == "escapement") %>%
group_by(stock_group, sampleYear) %>%
count(Salt.Water.Age) %>%
#group_by(stock_group, sampleYear) %>%
mutate(prop = n/sum(n))
ggplot(data = AL_chum) +
geom_point(aes(x=as.numeric(sampleYear), y = prop)) +
facet_grid(Salt.Water.Age~stock_group, scales = "free_y") +
theme_classic()
AL_chum <- chum_tidy %>%
#filter(ASLProjectType == "escapement") %>%
group_by(stock_group, sampleYear) %>%
count(Salt.Water.Age) %>%
#group_by(stock_group, sampleYear) %>%
mutate(prop = n/sum(n),
check =sum(n))
AL_chum <- chum_tidy %>%
#filter(ASLProjectType == "escapement") %>%
group_by(stock_group, sampleYear) %>%
count(Salt.Water.Age) %>%
#group_by(stock_group, sampleYear) %>%
mutate(prop = n/sum(n)#,
#check =sum(n)
)
ggplot(data = AL_chum) +
geom_point(aes(x=as.numeric(sampleYear), y = prop)) +
facet_grid(Salt.Water.Age~stock_group, scales = "free_y") +
theme_classic()
i=1
region_list <- unique(AL_chum$stock_group)
dfa_size_age_output <- list()
loo_size_age_output <- list()
region <- region_list[[i]]
##  0s are replaced with NA's and the data z-scored
all_dat <- AL_chum %>%
filter(stock_group == region) %>%
#dplyr::mutate(mean = scale(mean))  %>%
spread(Salt.Water.Age, prop)
View(all_dat)
##  0s are replaced with NA's and the data z-scored
all_dat <- AL_chum %>%
filter(stock_group == region) %>%
dplyr::select(-n) %>%
#dplyr::mutate(mean = scale(mean))  %>%
spread(Salt.Water.Age, prop) %>%
ungroup() %>%
arrange(sampleYear) %>%
dplyr::select(-sampleYear, -stock_group)
all_dat <-   na.omit(all_dat)
all_dat_mat <- t(all_dat)
region_list <- unique(AL_chum$stock_group)
dfa_size_age_output <- list()
loo_size_age_output <- list()
for (i in 1:length(region_list)) {
region <- region_list[[i]]
##  0s are replaced with NA's and the data z-scored
all_dat <- AL_chum %>%
filter(stock_group == region) %>%
dplyr::select(-n) %>%
#dplyr::mutate(mean = scale(mean))  %>%
spread(Salt.Water.Age, prop) %>%
ungroup() %>%
arrange(sampleYear) %>%
dplyr::select(-sampleYear, -stock_group)
all_dat <-   na.omit(all_dat)
all_dat_mat <- t(all_dat)
# fit models with a RW 1 trend process
dfa_rw <- fit_dfa(y = all_dat_mat, iter = mcmc_iter, thin = mcmc_thin, scale="zscore", chains = mcmc_chains, num_trends = 1,par_list="all")
loos_rw = loo::loo(dfa_rw$model,moment_match=TRUE)$estimates[3,]
# fit models with varying numbers of knots in a b-spline
dfa_bs<- fit_dfa(y = all_dat_mat, iter = mcmc_iter, thin = mcmc_thin,scale="zscore",
chains = mcmc_chains, num_trends = 1, trend_model = "bs",
n_knots = 16,par_list="all")
loos_bs = loo::loo(dfa_bs$model,moment_match=TRUE)$estimates[3,]
# fit models with a Gaussian process
dfa_gp<- fit_dfa(y = all_dat_mat, iter = mcmc_iter, thin = mcmc_thin,scale="zscore",
chains = mcmc_chains, num_trends = 1, trend_model = "gp",
n_knots = 16,par_list="all")
loos_gp = loo::loo(dfa_gp$model,moment_match=TRUE)$estimates[3,]
loo_size_age_output[[i]] = data.frame(model = c("dfa_rw", "dfa_bs", "dfa_gp"),
LOOIC = c(loos_rw[1],loos_bs[1],  loos_gp[1]),
SE = c(loos_rw[2],loos_bs[2],  loos_gp[2]))
dfa_size_age_output[[i]] <- list(dfa_rw,dfa_bs,dfa_gp)
model_names = c("dfa_rw", "dfa_bs", "dfa_gp")
names(dfa_size_age_output[[i]]) <- model_names
# mod_select<- loo_compare %>%
#   mutate(flag = case_when(LOOIC == min(LOOIC) ~ 1,
#                           TRUE ~ 0)) %>%
#   filter(flag ==1) %>%
#   dplyr::select(model)
# best_mod<-mod_select$model
# #select the best DFA /region... [may want to just do the same ones for simplicity]
# dfa_size_age_output[[i]] <- dfa_list[grep(print(best_mod), names(dfa_list))]
}
