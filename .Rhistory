stage_a_cov_plot<-stage_a_cov %>%
gather(2:7, key = "id", value = "value") %>%
dplyr::mutate(id = factor(id, levels = c("kusko_mean_discharge", "yukon_mean_discharge",
"kusko_aniak_mean_airtemp", "yukon_chena_mean_airtemp",
"SST_CDD_NBS", "gelatinous_zoop_NBS", "large_zoop_NBS")))
plota <- ggplot(data = stage_a_cov_plot, aes(x=Year, y = value, color = id, group = id)) +
geom_point( ) +
geom_line( ) +
scale_color_manual(guide = "none", values = PNWColors::pnw_palette(name="Starfish",n=7)) +
facet_wrap(~id, scales = "free",ncol=1) +
theme_classic()  +
ggtitle("Stage A Covariates")
plota
pdf("output/plot_covariates_a.pdf", width = 7, height = 12)
plota
dev.off()
# Stage A - Plot, scaled =============
stage_a_cov_plot_scale<-stage_a_cov_plot %>%
group_by(id) %>%
mutate(scale = scale(value))
plota <- ggplot(data = stage_a_cov_plot_scale, aes(x=Year, y = scale, color = id, group = id)) +
geom_point( ) +
geom_line( ) +
scale_color_manual(guide = "none", values = PNWColors::pnw_palette(name="Starfish",n=7)) +
facet_wrap(~id, scales = "free",ncol=1) +
theme_classic()  +
ggtitle("Stage A Covariates - Scaled") +
geom_hline(yintercept =0, linetype =2)
plota
pdf("output/plot_scaled_covariates_a.pdf", width = 7, height = 12)
plota
dev.off()
# Stage B - Load data =============
hatchery_chum_b<-read_csv("output/hatchery_Chum_Covariate_AKandAsia.csv") %>%
dplyr::rename(Chum_hatchery="sum") %>%
dplyr::select(Year, Chum_hatchery)
hatchery_pink_b <- read_csv("output/hatchery_Pink_Covariate_AKandAsia.csv") %>%
dplyr::rename(Pink_hatchery="sum") %>%
dplyr::select(Year, Pink_hatchery)
sst_b<-read_csv("data/processed_covariates/Stage_B_CDD.csv") %>%
dplyr::rename(SST_CDD_SEBS = "CDD",
Year = "year") %>%
dplyr::select(Year, SST_CDD_SEBS)
river_discharge_b <- read_csv("data/processed_covariates/Stage_B_YK_Discharge.csv") %>%
dplyr::select(Year, mean_discharge,id) %>%
spread(id, mean_discharge) %>%
rename(kusko_mean_discharge_summer = "Kusko",
yukon_mean_discharge_summer = "Yukon")
stage_b_cov<- left_join(river_discharge_b,sst_b)  %>%
left_join(hatchery_pink_b) %>%
left_join(hatchery_chum_b)
# Stage B - Save DF =============
write_csv(stage_b_cov, "data/processed_covariates/stage_b_all.csv")
# Stage B - Plots =============
stage_b_cov_plot<-stage_b_cov %>%
gather(2:6, key = "id", value = "value") %>%
dplyr::mutate(id = factor(id, levels = c("SST_CDD_SEBS",
"Chum_hatchery",
"Pink_hatchery",
"kusko_mean_discharge_summer",
"yukon_mean_discharge_summer" )))
plotb <- ggplot(data = stage_b_cov_plot, aes(x=Year, y = value, color = id, group = id)) +
geom_point( ) +
geom_line( ) +
scale_color_manual(guide = "none", values = PNWColors::pnw_palette(name="Sunset2",n=5)) +
facet_wrap(~id, scales = "free",ncol=1) +
theme_classic()  +
ylab(" ") +
ggtitle("Stage B Covariates")
plotb
pdf("output/plot_covariates_b.pdf", width = 7, height = 12)
plotb
dev.off()
# Covariates B - scale ==========
stage_b_cov_plot <- stage_b_cov_plot %>%
group_by(id) %>%
dplyr::mutate(scale = scale(value))
plotb <- ggplot(data = stage_b_cov_plot, aes(x=Year, y = scale, color = id, group = id)) +
geom_point( ) +
geom_line( ) +
scale_color_manual(guide = "none", values = PNWColors::pnw_palette(name="Sunset2",n=5)) +
facet_wrap(~id, scales = "free",ncol=1) +
theme_classic()  +
ylab(" ") +
ggtitle("Stage B Covariates - Scaled") +
geom_hline(yintercept = 0, linetype =2)
plotb
pdf("output/plot_Scaled_covariates_b.pdf",  width = 7, height = 12)
plotb
dev.off()
# Stage A: Plot individual covariates ==============================
## Discharge =============
dplyr::mutate(id = factor(id, levels = c("kusko_mean_discharge", "yukon_mean_discharge",
"kusko_aniak_mean_airtemp", "yukon_chena_mean_airtemp",
"SST_CDD_NBS", "gelatinous_zoop_NBS", "large_zoop_NBS")))
discharge <- stage_a_cov %>%
select(Year, kusko_mean_discharge,yukon_mean_discharge) %>%
gather(2:3, key = "id", value = "value") %>%
group_by(id) %>%
mutate(scale = scale(value))
rivera <- ggplot( data = discharge, aes(x=Year, y = scale, group = id, color =id)) +
geom_point(  ) +
geom_line( ) +
scale_color_manual(name = " ", values = PNWColors::pnw_palette(name="Bay",n=2)) +
theme_classic()  +
ggtitle("Stage A- Mean River Discharge") +
geom_hline(yintercept =0) +
ylab(" ") +
theme(legend.position = "bottom")
pdf("output/plot_Cov_Riverdischarge_A.pdf",  width = 7, height = 4)
rivera
dev.off()
## Airtemp =============
airtemp <- stage_a_cov %>%
select(Year, kusko_aniak_mean_airtemp,yukon_chena_mean_airtemp) %>%
gather(2:3, key = "id", value = "value") %>%
group_by(id) %>%
mutate(scale = scale(value))
airtempa <- ggplot( data = airtemp, aes(x=Year, y = scale, group = id, color =id)) +
geom_point(  ) +
geom_line( ) +
scale_color_manual(name = " ", values = PNWColors::pnw_palette(name="Bay",n=2)) +
theme_classic()  +
ggtitle("Stage A- Mean Air Temp") +
geom_hline(yintercept =0) +
ylab(" ") +
theme(legend.position = "bottom")
pdf("output/plot_Cov_AirTemp_A.pdf",  width = 7, height = 4)
airtempa
dev.off()
## SST NBS =============
SST_NBS <- stage_a_cov %>%
select(Year, SST_CDD_NBS) %>%
mutate(scale = scale(SST_CDD_NBS))
SST_NBSa <- ggplot( data = SST_NBS, aes(x=Year, y = scale), color = "#4682B4") +
geom_point( color = "#4682B4" ) +
geom_line( color = "#4682B4" ) +
# scale_color_manual(name = " ", values = PNWColors::pnw_palette(name="Bay",n=2)) +
theme_classic()  +
ggtitle("Stage A- NBS SST (cummulative degree days)") +
geom_hline(yintercept =0) +
ylab(" ") #+
#theme(legend.position = "bottom")
pdf("output/plot_SST_NBSCDD_A.pdf",  width = 7, height = 4)
SST_NBSa
dev.off()
## Large zooplankton =============
large_zoop <- stage_a_cov %>%
select(Year, large_zoop_NBS) %>%
mutate(scale = scale(large_zoop_NBS))
large_zoopa <- ggplot( data = large_zoop, aes(x=Year, y = scale) ) +
geom_point( color = "#e1ad01" ) +
geom_line( color = "#e1ad01" ) +
# scale_color_manual(name = " ", values = PNWColors::pnw_palette(name="Bay",n=2)) +
theme_classic()  +
ggtitle("Stage A- Large zooplankton NBS") +
geom_hline(yintercept =0) +
ylab(" ")
pdf("output/plot_largezoop_A.pdf",  width = 7, height = 4)
large_zoopa
dev.off()
## Gelatinous zooplankton =============
gelatinous_zoop <- stage_a_cov %>%
select(Year, gelatinous_zoop_NBS) %>%
mutate(scale = scale(gelatinous_zoop_NBS))
gelatinous_zoopa <- ggplot( data = gelatinous_zoop, aes(x=Year, y = scale) ) +
geom_point( color = "#301934" ) +
geom_line( color = "#301934" ) +
# scale_color_manual(name = " ", values = PNWColors::pnw_palette(name="Bay",n=2)) +
theme_classic()  +
ggtitle("Stage A- Gelatinous zooplankton NBS") +
geom_hline(yintercept =0) +
ylab(" ")
pdf("output/plot_gelatinouszoop_A.pdf",  width = 7, height = 4)
gelatinous_zoopa
dev.off()
# Stage B: Plot individual covariates ==============================
## SST =============
# c("SST_CDD_SEBS",
#   "Chum_hatchery",
#   "Pink_hatchery",
#   "kusko_mean_discharge_summer",
#   "yukon_mean_discharge_summer" )))
SST_SEBS <- stage_b_cov %>%
select(Year, SST_CDD_SEBS)  %>%
mutate(scale = scale(SST_CDD_SEBS))
sstb <- ggplot( data = SST_SEBS, aes(x=Year, y = scale )) +
geom_point(color = "#4B5320"  ) +
geom_line(color = "#4B5320" ) +
scale_color_manual(name = " ", values = PNWColors::pnw_palette(name="Bay",n=2)) +
theme_classic()  +
ggtitle("Stage B- SST SEBS (CDD January-June)") +
geom_hline(yintercept =0) +
ylab(" ") +
theme(legend.position = "bottom")
pdf("output/plot_SST_CDD_SEBS_B.pdf",  width = 7, height = 4)
sstb
dev.off()
## discharge =============
# c("SST_CDD_SEBS",
#   "Chum_hatchery",
#   "Pink_hatchery",
#   "kusko_mean_discharge_summer",
#   "yukon_mean_discharge_summer" )))
discharge <- stage_b_cov %>%
select(Year, kusko_mean_discharge_summer,yukon_mean_discharge_summer) %>%
gather(2:3, key = "id", value = "value") %>%
group_by(id) %>%
mutate(scale = scale(value))
riverb <- ggplot( data = discharge, aes(x=Year, y = scale, group = id, color =id)) +
geom_point(  ) +
geom_line( ) +
scale_color_manual(name = " ", values = PNWColors::pnw_palette(name="Bay",n=2)) +
theme_classic()  +
ggtitle("Stage B - Mean River Discharge, Summer") +
geom_hline(yintercept =0) +
ylab(" ") +
theme(legend.position = "bottom")
pdf("output/plot_Cov_Riverdischarge_B.pdf",  width = 7, height = 4)
riverb
dev.off()
## hatchery =============
# c("SST_CDD_SEBS",
#   "Chum_hatchery",
#   "Pink_hatchery",
#   "kusko_mean_discharge_summer",
#   "yukon_mean_discharge_summer" )))
hatchery <- stage_b_cov %>%
select(Year, Pink_hatchery,Chum_hatchery) %>%
gather(2:3, key = "id", value = "value") %>%
group_by(id) %>%
mutate(scale = scale(value))
hatcheryb <- ggplot( data = hatchery, aes(x=Year, y = scale, group = id, color =id)) +
geom_point(  ) +
geom_line( ) +
scale_color_manual(name = " ", values = PNWColors::pnw_palette(name="Sunset2",n=2)) +
theme_classic()  +
ggtitle("Stage B - Hatchery releases") +
geom_hline(yintercept =0) +
ylab(" ") +
theme(legend.position = "bottom")
pdf("output/plot_Cov_hatchery_B.pdf",  width = 7, height = 4)
hatcheryb
dev.off()
#  covariates =================
stage_a_cov <- read_csv("data/processed_covariates/stage_a_all.csv") %>%
filter(Year >= year_min,
Year <= year_max_brood) %>%
dplyr::mutate(yukon_mean_discharge = as.numeric(scale(yukon_mean_discharge)),
SST_CDD_NBS = as.numeric(scale(SST_CDD_NBS))) %>%
dplyr::select(yukon_mean_discharge,SST_CDD_NBS, Cnideria, Large_zoop) %>%
as.matrix()
stage_b_cov <- read_csv("data/processed_covariates/stage_b_all.csv") %>%
filter(Year >= year_min,
Year <= year_max_brood
) %>%
dplyr::mutate(SST_CDD_SEBS = as.numeric(scale(SST_CDD_SEBS)),
Chum_hatchery= as.numeric(scale(Chum_hatchery)),
Pink_hatchery= as.numeric(scale(Pink_hatchery)),
yukon_mean_discharge_summer= as.numeric(scale(yukon_mean_discharge_summer))) %>%
dplyr::select(SST_CDD_SEBS,Chum_hatchery,Pink_hatchery,yukon_mean_discharge_summer) %>%
as.matrix()
View(stage_a_cov)
View(stage_b_cov)
plot(stage_b_cov[,1])
library(rstan)
library(tidyverse)
library(here)
library(bayesplot)
library(rstanarm)
library(tidync)
library(lubridate)
library(readxl)
# log_f = runif(1,-4,-1)
# 1-exp(-exp(log_f))
# Things to look into  =======================================================
# sigma for both life stages in estimates so I can fix it instead of have model estimate it
# Load data ==================================================================
# see 01_make salmon data.R for salmon data tidying
# see 02_make covariates for data tidying
# setup inputs ===============================================================
warmups <- 2000
total_iterations <- 4000
max_treedepth <-  15
n_chains <- 4
n_cores <- 4
adapt_delta <- 0.95
year_min = 2002
year_max_cal = 2022
year_max_brood = 2021
# load salmon data ==============================================
## Fall age comp ================================================
yukon_fall_obs_agecomp <- read_csv("data/processed_data/yukon_fall_age_comp.csv") %>%
filter(cal_year >= year_min,
cal_year <= 2022
) %>%
dplyr::select(2:ncol(.)) %>%
as.matrix()
## Spawners, Recruits, Harvest ====================================
yukon_fall_spawners <-read_csv("data/processed_data/yukon_fall_spawners.csv") %>%
filter(cal_year >= year_min #,
#cal_year <= year_max_cal
) %>%
select(2) %>%
as.vector()
yukon_fall_harvest<-read_csv("data/processed_data/yukon_fall_harvest.csv") %>%
filter(cal_year >= year_min#,
#cal_year <= year_max_cal
)%>%
select(2) %>%
as.vector()
yukon_fall_recruits<-read_csv("data/processed_data/yukon_fall_recruits.csv") %>%
filter(cal_year >= year_min#,
#cal_year <= year_max_cal
) %>%
select(2) %>%
as.vector()
## Fall Juveniles ================================================
fall_juv <- read_csv("data/processed_data/tidy_juv_fall_yukon.csv")  %>%
filter(Year <= 2021) %>% # 1 year less than all spawners
select(2) %>%
as.vector()
# CV ========================================
spawner_cv <- read_xlsx("data/chum_cv.xlsx") %>%
filter(year >= year_min,
year <= 2022)
fall_juv_cv <- read_csv("data/processed_data/tidy_juv_fall_yukon.csv")  %>%
filter(Year <= 2021) %>% # 1 year less than all spawners
dplyr::select(3) %>%
as.vector()
# Summer ================================================
# summer_age_comp<-read_csv("data/age_comps/processed_age_comps_summer_yukon.csv")  %>%
#   filter(!cal_year < 2005 )
# summer_brood <- read_csv("output/yukon_summer_broodyear.csv")%>%
#   filter(!brood_year < 2002) # for now to simplify matching with juveniles
# yukon_summer <- read_excel("data/Yukon_Escapement_ADFG/S Chum RR 2023.xlsx", sheet = 2) %>%
#   dplyr::select(1,11:14) %>%
#   janitor::row_to_names(row_number = 1) %>%
#   dplyr::rename(cal_year = "Year")  %>%
#   dplyr::mutate(age3=as.numeric(age3),
#                 age4=as.numeric(age4),
#                 age5=as.numeric(age5),
#                 age6=as.numeric(age6)) %>%
#   filter(!cal_year < 2005)
# ## harvest below weir
# harvest_escapement <- read_excel("data/Yukon_Escapement_ADFG/S Chum RR 2023.xlsx", sheet = 2) %>%
#   dplyr::select(1:2,4) %>%
#   janitor::row_to_names(row_number = 1)  %>%
#   dplyr::rename(cal_year = "Year") %>%
#   dplyr::mutate(cal_year = as.numeric(cal_year),
#          Harvest = as.numeric(Harvest),
#          Escapement = as.numeric(Escapement)) %>%
#   filter(!cal_year < 2005) %>% # from brood year 2002 (first year of juvenile data), the first year that fish could return is 2005 if its a 3yo, the last yera it coudl return is 2007 if its a 6yo.
#   as.data.frame()  #%>%
#  #as.matrix()
#  covariates =================
stage_a_cov <- read_csv("data/processed_covariates/stage_a_all.csv") %>%
filter(Year >= year_min,
Year <= year_max_brood) %>%
dplyr::mutate(yukon_mean_discharge = as.numeric(scale(yukon_mean_discharge)),
SST_CDD_NBS = as.numeric(scale(SST_CDD_NBS))) %>%
dplyr::select(yukon_mean_discharge,SST_CDD_NBS, Cnideria, Large_zoop) %>%
as.matrix()
stage_b_cov <- read_csv("data/processed_covariates/stage_b_all.csv") %>%
filter(Year >= year_min,
Year <= year_max_brood
) %>%
dplyr::mutate(SST_CDD_SEBS = as.numeric(scale(SST_CDD_SEBS)),
Chum_hatchery= as.numeric(scale(Chum_hatchery)),
Pink_hatchery= as.numeric(scale(Pink_hatchery)),
yukon_mean_discharge_summer= as.numeric(scale(yukon_mean_discharge_summer))) %>%
dplyr::select(SST_CDD_SEBS,Chum_hatchery,Pink_hatchery,yukon_mean_discharge_summer) %>%
as.matrix()
plot(stage_b_cov[,1])
plot(stage_b_cov[,2])
plot(stage_b_cov[,3])
plot(stage_b_cov[,4])
# number covariates for each life stage
ncovars1 = 4
ncovars2 = 4
# Organize data call inputs ================================================
nByrs = nrow(fall_juv) # Number of BROOD years
nRyrs = nrow(yukon_fall_harvest)  # Number of CAL/RETURN
nRyrs_T = nRyrs + 4
A = 4 # number of age classes, 3,4,5,6
K = 1 # number of stocks
Ps = 0.5 # proportion of females - assumption, need to lit check
fs = as.vector(c(1800, 2000, 2200, 2440)) # fecundity - Gilk-Baumer 2009 estimate for Kusko Chum is: 2440. I added extra numbers temporarily just so that younger fish reproduce less, but will have to look up data for this more...
t_start = 5 # to fill starting values
# mean productivity rate =====
# estimating this now
basal_p_1 = 0.08#0.1#,0.05,
#0.05) # straight from simulation
basal_p_2 = 0.2#0.4#,
# 0.15,
# 0.15) # straight from simulation
# fix marine mortality =======
# generally low mortality in ocean for older life stages
M_fill_stan = c(0.06, 0.06, 0.06) # will be cumulative
#ess age comp =======
ess_age_comp = as.vector(rep(80, times = nByrs))
# STAN STARTING VALUES ==========
kappa_j_start =  basal_p_1
kappa_marine_start = basal_p_2
# N_j_start =  as.vector(NA)
# N_e_sum_start = as.vector(NA)
#
# N_recruit_start = matrix(NA,nrow=t_start, ncol=A)
# N_catch_start = matrix(NA,nrow=t_start, ncol=A)
#  N_egg_start = matrix(NA,nrow=t_start, ncol=A)
# N_ocean_start = matrix(NA,nrow=t_start, ncol=A)#vector() # ages # array(data = NA, dim = c(1, A))
# N_sp_start = matrix(NA,nrow=t_start, ncol=A)#vector() # array(data = NA, dim = c(1, A,K))
#
# N_j_start = exp(rnorm(1,15,2))
# N_e_sum_start = exp(rnorm(1,20,2)) #exp(rnorm(1,30,2))
# use average age comp to distribute starting values
p <- colMeans(yukon_fall_obs_agecomp[1:21,])
#
# for(t in 1:t_start){
#   N_recruit_start[t,] = exp(rnorm(1,12.9,2))*p
#   N_ocean_start[t,] = exp(rnorm(1,13,2))*p
#   N_sp_start[t,] = exp(rnorm(1,12.2,2))*p #exp(rnorm(1,log(398700),2))*p
#   N_catch_start[t,] = exp(rnorm(1,10.6,2))*p #exp(rnorm(1,log(27769),2))*p
#   N_egg_start[t,] = exp(rnorm(1,20,2))*p
# }
# ASSIGN DATA ==========
data_list_stan <- list(nByrs=nByrs,
nRyrs=nRyrs,
nRyrs_T = nRyrs_T,
A=A,
t_start = t_start,
Ps=Ps,
fs=fs,
M = M_fill_stan,
# basal_p_1=basal_p_1,
# basal_p_2=basal_p_2, estimating these now
data_sp_cv = spawner_cv$fall_spawner_cv,
data_j_cv = fall_juv_cv$CV,
data_stage_j = as.vector(fall_juv$fall_abundance),
data_stage_return = as.vector(yukon_fall_recruits$total_run),
data_stage_sp = as.vector(yukon_fall_spawners$Spawners),
data_stage_harvest = as.vector(yukon_fall_harvest$harvest),
# N_ocean_start = N_ocean_start,
# N_egg_start = N_egg_start,
# N_j_start =  N_j_start,
# N_e_sum_start = N_e_sum_start,
kappa_marine_mort_start = c(-log(basal_p_2), -log(basal_p_2)),
kappa_marine_start = c(basal_p_2, basal_p_2),
kappa_j_start = basal_p_1,
ncovars1=ncovars1,
ncovars2=ncovars2,
cov1=stage_a_cov,
cov2=stage_b_cov,
o_run_comp=yukon_fall_obs_agecomp,
ess_age_comp=ess_age_comp,
p_obs = p)
# call mod  ===========================
bh_fit <- stan(
file = here::here("scripts", "stan_mod_BH_dat.stan"),
data = data_list_stan,
chains = 1,#n_chains,
warmup = warmups,
iter = total_iterations,
cores = n_cores)
write_rds(bh_fit, "output/stan_fit_DATA.RDS")
# Plot Observed vs Predicted ========
## Spawners ==========
pred_N_SP <- summary(bh_fit, pars = c("N_sp"),
probs = c(0.1, 0.9))$summary %>%
data.frame() %>%
rownames_to_column()  %>%
dplyr::mutate(time = rep(1:25, each=4),
age = rep(1:4, length.out = nrow(.))) %>%
filter(!time>21) # remove years without full return estimates
# plot proportions
# sum to compare with data
summ_n_sp <- pred_N_SP %>%
group_by(time) %>%
summarise(pred_n_sp = sum(mean),
pred_se = mean(se_mean)) %>%
cbind(obs = data_list_stan$data_stage_sp)
ggplot(data = summ_n_sp) +
geom_point(aes(x=time, y = obs)) +
geom_line(aes(x=time, y = pred_n_sp)) +
geom_ribbon(aes(x=time, ymin = pred_n_sp-pred_se,
ymax = pred_n_sp+pred_se))
## recruits ======
pred_N_recruit <- summary(bh_fit, pars = c("N_recruit"),
probs = c(0.1, 0.9))$summary %>%
data.frame() %>%
rownames_to_column()  %>%
dplyr::mutate(time = rep(1:25, each=4),
age = rep(1:4, length.out = nrow(.))) %>%
filter(!time>21)
# sum to compare with data
summ_n_rec <- pred_N_recruit %>%
group_by(time) %>%
summarise(pred_n_rec = sum(mean),
pred_se = mean(se_mean)) %>%
cbind(obs = data_list_stan$data_stage_return)
ggplot(data = summ_n_rec) +
geom_point(aes(x=time, y = obs)) +
geom_line(aes(x=time, y = pred_n_rec)) +
geom_ribbon(aes(x=time, ymin = pred_n_rec-pred_se,
ymax = pred_n_rec+pred_se))+
ggtitle(("Recruits, est and observed"))
ggplot(data = summ_n_rec) +
geom_point(aes(x=time, y = obs)) +
geom_line(aes(x=time, y = pred_n_rec)) +
geom_ribbon(aes(x=time, ymin = pred_n_rec-pred_se,
ymax = pred_n_rec+pred_se))+
ggtitle(("Recruits, est and observed"))
